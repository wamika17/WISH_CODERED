<!DOCTYPE html>
<html>
<head>
    <title>Restaurant Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 50px;
            background: #fafafa;
        }
        #restaurantName {
            font-size: 28px;
            margin-top: 20px;
            font-weight: bold;
        }
        .join-btn {
            display: inline-block;
            margin-top: 40px;
            padding: 15px 40px;
            background-color: #ff5722;
            color: white;
            font-size: 20px;
            border-radius: 8px;
            text-decoration: none;
        }
        #debug {
            margin-top:20px;
            font-size:12px;
            color:#666;
        }
    </style>
</head>

<body>

    <h1>Welcome!</h1>
    <p>Detecting the place you are in...</p>

    <div id="restaurantName">"Loading..."</div>

    <a href="customer.html" class="join-btn">Join</a>


    <div id="debug"></div>

    <script>
        // Put your Geoapify key here (you had one in your file)
        const apiKey = "aa4dba1f10b34d5eb29271543b732ce9";

        function debugLog(msg) {
            console.log(msg);
            const d = document.getElementById('debug');
            d.innerText = msg;
        }

        // Try multiple radii until we find a named place
        async function findPlaceWithRadii(lat, lng) {
            const radii = [30, 80, 200]; // meters: try close then expand
            for (let r of radii) {
                debugLog(`Searching for places within ${r}m...`);
                const url = `https://api.geoapify.com/v2/places?categories=building,education,catering,service,commercial,tourism&filter=circle:${lng},${lat},${r}&limit=3&apiKey=${apiKey}`;

                try {
                    console.log('Geoapify URL:', url);
                    const res = await fetch(url);
                    if (!res.ok) {
                        console.error('Network response not ok', res.status, res.statusText);
                        debugLog(`Network error: ${res.status}`);
                        continue;
                    }
                    const data = await res.json();
                    console.log('Geoapify response:', data);

                    if (data.features && data.features.length > 0) {
                        // pick the best candidate (prefer ones with a non-empty name)
                        const candidate = data.features.find(f => f.properties && f.properties.name) || data.features[0];
                        const name = candidate.properties.name || candidate.properties.address || "Unnamed place";
                        document.getElementById("restaurantName").innerText = `"${name}"`;
                        debugLog(`Found: "${name}" (radius ${r}m)`);
                        return;
                    } else {
                        debugLog(`No places within ${r}m`);
                    }

                } catch (err) {
                    console.error('Fetch error', err);
                    debugLog('Error fetching Geoapify data (see console)');
                }
            }

            // If we get here, nothing was found in any radius
            document.getElementById("restaurantName").innerText = `"No named place found nearby"`;
            debugLog('Tried all radii — no place found.');
        }

        // Get user's GPS location
        function requestLocation() {
            if (!navigator.geolocation) {
                document.getElementById("restaurantName").innerText = `"Geolocation not supported"`;
                debugLog('Geolocation is not supported by this browser.');
                return;
            }

            debugLog('Requesting location permission...');
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    console.log('User coords:', lat, lng);
                    debugLog(`Got coords: ${lat.toFixed(6)}, ${lng.toFixed(6)} — searching...`);
                    findPlaceWithRadii(lat, lng);
                },
                (err) => {
                    console.error('Geolocation error', err);
                    if (err.code === 1) {
                        document.getElementById("restaurantName").innerText = `"Location Permission Required"`;
                        debugLog('Location permission denied by user.');
                    } else {
                        document.getElementById("restaurantName").innerText = `"Unable to get location"`;
                        debugLog(`Location error: ${err.message}`);
                    }
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        // Start
        requestLocation();
    </script>

</body>
</html>
